'''Date: 11/01/25This script is used to compare the heatwaves defined across the max, EHF, and Pezza approaches. It will compare the heatwaves defined across each site by thethree different approaches, as well as the distribution of moisture conditionsby the approaches.Importing the testing_heatwaves below will provide the following objects:    heatwaves, heatwaves_EHF, heatwaves_Pezza = heatwave dictionaries for each approach    all_precip, all_precip_EHF, all_precip_Pezza = precipitation dataframe for each approach    all_swc, all_swc_EHF, all_swc_Pezza = soil water content dataframe for each approach'''import osos.chdir("/Users/marleeyork/Documents/project2/heatwave_definition/")from testing_heatwaves import *import matplotlib.image as mpimgimport matplotlib.pyplot as pltimport pandas as pdimport seaborn as sns# Set pandas to print first 110 rowspd.set_option('display.max_rows', 110)AMF_data = AMF_data[AMF_data['Site']!='US-Ne1']#################################################################################                             Comparison                                    ################################################################################## Now we are going to compare heatwaves defined across each of the 3 approaches# Just stacking the plots of each on top of eachotherfor site in AMF_data.Site.unique():    fig1 = heatwaves[site]['plot']    fig2 = heatwaves_EHF[site]['plot']    fig3 = heatwaves_min[site]['plot']    fig1.savefig("plot1.png", bbox_inches="tight")    fig2.savefig("plot2.png", bbox_inches="tight")    fig3.savefig("plot3.png", bbox_inches="tight")    imgs = [mpimg.imread(f"plot{i}.png") for i in range(1, 4)]    fig, axes = plt.subplots(3, 1, figsize=(6, 12))    for ax, img in zip(axes, imgs):        ax.imshow(img)        ax.axis("off")    plt.tight_layout()    plt.show()    #################################################################################                             Summaries                                     ################################################################################## Printing the summaries of heatwaves for each site# Starting with the Max summariesfor site in AMF_data.Site.unique():    print(heatwaves[site]['summary'])    plt.show(heatwaves[site]["plot"])        # input("Press [enter] to continue...") # careful with this, can break things# EHF summariesfor site in heatwaves_EHF.keys():    print(heatwaves_EHF[site]['summary'])    plt.show(heatwaves_EHF[site]["plot"])    # Min summaries# Print each of the heatwave summarysfor site in heatwaves_min.keys():    print(heatwaves_min[site]['summary'])    plt.show(heatwaves_min[site]["plot"])#################################################################################                             Moisture                                      ################################################################################## Plotting moisture from max approach# Plot distributions of all moisture datafig, ax = plt.subplots(1,3,figsize=(12,4))ax[0].set_title('Total Precipitation')ax[0].set_xlabel('Precipitation (mm)')ax[0].hist(all_precip['moisture_total'],bins=30)ax[1].hist(all_precip['moisture_average'],bins=30)ax[1].set_title('Average Precipitation')ax[1].set_xlabel('Precipitation (mm)')ax[2].hist(all_swc['moisture_average'],bins=30)ax[2].set_title('Average SWC')ax[2].set_xlabel('SWC (% at -2cm')plt.show()# Plotting moisture from EHF approach# Plot distributions of all moisture datafig, ax = plt.subplots(1,3,figsize=(12,4))ax[0].set_title('Total Precipitation')ax[0].set_xlabel('Precipitation (mm)')ax[0].hist(all_precip_EHF['moisture_total'],bins=30)ax[1].hist(all_precip_EHF['moisture_average'],bins=30)ax[1].set_title('Average Precipitation')ax[1].set_xlabel('Precipitation (mm)')ax[2].hist(all_swc_EHF['moisture_average'],bins=30)ax[2].set_title('Average SWC')ax[2].set_xlabel('SWC (% at -2cm)')plt.show()# Plotting moisture from Pezza approach# Plot distributions of all moisture datafig, ax = plt.subplots(1,3,figsize=(12,4))ax[0].set_title('Total Precipitation')ax[0].set_xlabel('Precipitation (mm)')ax[0].hist(all_precip_Pezza['moisture_total'],bins=30)ax[1].hist(all_precip_Pezza['moisture_average'],bins=30)ax[1].set_title('Average Precipitation')ax[1].set_xlabel('Precipitation (mm/day)')ax[2].hist(all_swc_Pezza['moisture_average'],bins=30)ax[2].set_title('Average SWC')ax[2].set_xlabel('SWC (% at -2cm)')plt.show()#################################################################################                          Moisture by IGBP                                 ################################################################################## Importing site information to retrieve IGBPsite_data = pd.read_csv("/Users/marleeyork/Documents/project2/data/site_list.csv",encoding='latin1')# Isolate the site and IGBPIGBP = site_data[['Site ID','Vegetation Abbreviation (IGBP)']]IGBP.columns = ['Site','IGBP']# Merge with the swc dataframesall_swc = pd.merge(all_swc,IGBP,on='Site',how='inner').drop_duplicates()all_swc_EHF = pd.merge(all_swc_EHF,IGBP,on='Site',how='inner').drop_duplicates()all_swc_min = pd.merge(all_swc_min,IGBP,on='Site',how='inner').drop_duplicates()# Merge with precipitation dataframesall_precip = pd.merge(all_precip,IGBP,on='Site',how='inner').drop_duplicates()all_precip_EHF = pd.merge(all_precip_EHF,IGBP,on='Site',how='inner').drop_duplicates()all_precip_min = pd.merge(all_precip_min,IGBP,on='Site',how='inner').drop_duplicates()# Plot swc histograms grouped by site# Plotting for the max approachplt.figure(figsize=(8,6))sns.kdeplot(    data=all_swc[all_swc["moisture_average"] >= 0],    x="moisture_average",    hue="IGBP",    common_norm=False,    cut=0,           clip=(0, None),    linewidth=2)plt.xlim(0, None)plt.title("SWC Density of Heatwaves by IGBP (Max approach)")plt.xlabel("Average SWC")plt.ylabel("Density")plt.show()# Plotting for the EHF approachplt.figure(figsize=(8,6))sns.kdeplot(    data=all_swc_EHF[all_swc_EHF["moisture_average"] >= 0],    x="moisture_average",    hue="IGBP",    common_norm=False,    cut=0,           clip=(0, None),    linewidth=2)plt.xlim(0, None)plt.title("SWC Density of Heatwaves by IGBP (EHF approach)")plt.xlabel("SWC Average")plt.ylabel("Density")plt.show()# Plotting for the Pezza approachplt.figure(figsize=(8,6))sns.kdeplot(    data=all_swc_min[all_swc_min["moisture_average"] >= 0],    x="moisture_average",    hue="IGBP",    common_norm=False,    cut=0,           clip=(0, None),    linewidth=2)plt.xlim(0, None)plt.title("SWC Density of Heatwaves by IGBP (Min approach)")plt.xlabel("Average SWC")plt.ylabel("Density")plt.show()#################################################################################                               Summaries                                   ################################################################################## Organize all the heatwaves into dataframes# Starting with max approachheatwave_df = pd.DataFrame(columns=['Site','start_dates','end_dates','duration'])for site in AMF_data.Site.unique():    # Isolate heatwaves from each approach    maximum = heatwaves[site]['summary'][['start_dates','end_dates','duration']]    EHF = heatwaves_EHF[site]['summary']    minimum = heatwaves_min[site]['summary']    # Label the approach type    maximum["Method"] = ['Max']*maximum.shape[0]    EHF["Method"] = ['EHF']*EHF.shape[0]    minimum["Method"] = ['Min']*minimum.shape[0]    # Add site name to each    maximum['Site'] = [site]*maximum.shape[0]    EHF['Site'] = [site]* EHF.shape[0]    minimum['Site'] = [site]*minimum.shape[0]    # Concat into one dataframe    heatwave_df = pd.concat([heatwave_df,maximum])    heatwave_df = pd.concat([heatwave_df,EHF])    heatwave_df = pd.concat([heatwave_df,minimum])    # Add IGBP to the dataframeheatwave_df = pd.merge(heatwave_df,IGBP,on='Site',how='inner')# For the sake of this analysis, I am going to drop the croplandsheatwave_df = heatwave_df[heatwave_df['IGBP']!="CRO"]# Now we start calculating some interesting statistics# Number of heatwaves overall, and for each IGBPheatwave_df.groupby("Method").count()heatwave_df.groupby(["Method","IGBP"]).count()# Investigating the time of year# Adding a seasonal categorical variable and adding into the dataframeseasons = []for dt in heatwave_df.start_dates:    if dt.month in [3,4,5]:        seasons.append('Spring')    elif dt.month in [6,7,8]:        seasons.append('Summer')    elif dt.month in [9,10,11]:        seasons.append('Fall')    elif dt.month in [12,1,2]:        seasons.append('Winter')    else:        print(f"Something went wrong with date {dt}.")        seasons.append("Error")heatwave_df['Season'] = seasons    # Counting the number of heatwaves for each seasonheatwave_df.groupby(["Method","Season"]).count()    # Looking at the average duration of heatwavesheatwave_df.duration = heatwave_df.duration.dt.daysheatwave_df.groupby("Method").duration.mean()heatwave_df.groupby("Method").duration.quantile([0,.05,.25,.5,.75,.95,1])# Now we investigate the moisture conditions across each# Renaming columns of soil water content dataframesall_swc.columns = ['start_date','end_date','swc_average','swc_total','Site','IGBP']all_swc_EHF.columns = ['start_date','end_date','swc_average','swc_total','Site','IGBP']all_swc_min.columns = ['start_date','end_date','swc_average','swc_total','Site','IGBP']# Adding a methods column to eachall_swc["Method"] = ["Max"]*all_swc.shape[0]all_swc_EHF["Method"] = ["EHF"]*all_swc_EHF.shape[0]all_swc_min["Method"] = ["Min"]*all_swc_min.shape[0]# Concatenate the swc dataframesswc = pd.concat([all_swc,all_swc_EHF,all_swc_min])swc.columns = ['start_dates','end_dates','swc_average','swc_total','Site','IGBP','Method']# Match swc to each heatwave using mergeheatwave_df = pd.merge(heatwave_df,swc,on=["Site","Method","start_dates","end_dates","IGBP"],how="inner")# Calculate the quantiles for swcheatwave_df.swc_average = heatwave_df.swc_average.astype("int")heatwave_df.groupby("Method").swc_average.quantile([.05,.25,.5,.75,.95])# Now we do the same for precipitation# Start by rrenaming columns of precipitation dataframesall_precip.columns = ['start_dates','end_dates','precip_average','precip_total','Site','Duration','IGBP']all_precip_EHF.columns = ['start_dates','end_dates','precip_average','precip_total','Site','Duration','IGBP']all_precip_Pezza.columns = ['start_dates','end_dates','precip_average','precip_total','Site','Duration','IGBP']# Adding a methods columns to eachall_precip["Method"] = ["Max"]*all_precip.shape[0]all_precip_EHF["Method"] = ["EHF"]*all_precip_EHF.shape[0]all_precip_Pezza["Method"] = ["Pezza"]*all_precip_Pezza.shape[0]# Concatenate the dataframesprecip = pd.concat([all_precip,all_precip_EHF,all_precip_Pezza])# Merge precipitation onto the heatwavesheatwave_df = pd.merge(heatwave_df,precip.drop(columns=['Duration']),on=["Site","Method","start_dates","end_dates","IGBP"],how="inner")# Calculate the quantiles for precipitationheatwave_df.groupby(["Method","IGBP"]).precip_total.quantile([.05,.25,.5,.75,1])heatwave_df.groupby(["Method","IGBP"]).precip_average.quantile([.05,.25,.5,.75,1])# Now lets create a boxplot that compares these quantiles# Starting with SWCsns.boxplot(data=heatwave_df, x='IGBP', y='swc_average', hue='Method')plt.title('Avg SWC by IGBP and Method')plt.ylabel("SWC Average (%/d) per Heatwave")plt.show()# Now precipitation totalsns.boxplot(data=heatwave_df, x='IGBP', y='precip_total', hue='Method')plt.title('Total Preciptation by IGBP and Method')plt.ylabel("Precipitation Total (mm) per Heatwave")plt.show()# Now precipitation averagesns.boxplot(data=heatwave_df, x='IGBP', y='precip_average', hue='Method')plt.title('Avg Preciptation by IGBP and Method')plt.ylabel("Precipitation Avg (mm/d) per Heatwave")plt.show()# Standardizing SWC and precipitation by site# First find the mean SWC at each site# Need to find where the precipitation data is stored... and if the swc_data is the right dataframeswc_site_data = swc_data.groupby('Site')['SWC_F_MDS_1'].agg(['mean', 'std']).reset_index()swc_site_data.columns = ['Site','swc_site_mean','swc_site_sd']prec_site_data = prec_data.groupby('Site')['P_F'].agg(['mean','std']).reset_index()prec_site_data.columns = ['Site','prec_site_mean','prec_site_sd']# Now merge with the heatwave dfheatwave_df = pd.merge(heatwave_df,swc_site_data,on="Site",how="inner")heatwave_df = pd.merge(heatwave_df,prec_site_data,on="Site",how="inner")# Calculate the standardized vaues of moisture conditions# Note: standardized in assumes normality, which is not true here. I also included just the centered values.heatwave_df['swc_standardized'] = (heatwave_df['swc_average'] - heatwave_df['swc_site_mean']) / heatwave_df['swc_site_sd']heatwave_df['swc_centered'] = heatwave_df['swc_average'] - heatwave_df['swc_site_mean']heatwave_df['prec_standardized'] = (heatwave_df['precip_average'] - heatwave_df['prec_site_mean']) / heatwave_df['prec_site_mean']heatwave_df['prec_centered'] = heatwave_df['precip_average'] - heatwave_df['prec_site_mean']# Make a boxplot of centered average soil water contentsns.boxplot(data=heatwave_df, x='IGBP', y='swc_centered', hue='Method')plt.axhline(0, color='black', linestyle='--', linewidth=1)plt.title('Avg SWC of Heatwaves Centered by Site by IGBP')plt.ylabel("Centered Heatwave Avg SWC (%/d) by IGBP")plt.show()# Make a boxplot of centered average precipitationsns.boxplot(data=heatwave_df,x="IGBP",y="prec_centered",hue="Method")plt.axhline(0,color="black",linestyle="--",linewidth=1)plt.title('Avg Precipitation of Heatwaves Centered by Site by IGBP')plt.ylabel("Centered Heatwave Avg Precipitation (mm/d) by IGBP")plt.show()