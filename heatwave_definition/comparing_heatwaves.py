'''Date: 11/01/25This script is used to compare the heatwaves defined across the max, EHF, and Pezza approaches. It will compare the heatwaves defined across each site by thethree different approaches, as well as the distribution of moisture conditionsby the approaches.Importing the testing_heatwaves below will provide the following objects:    heatwaves, heatwaves_EHF, heatwaves_Pezza = heatwave dictionaries for each approach    all_precip, all_precip_EHF, all_precip_Pezza = precipitation dataframe for each approach    all_swc, all_swc_EHF, all_swc_Pezza = soil water content dataframe for each approach'''import osos.chdir("/Users/marleeyork/Documents/project2/heatwave_definition/")import matplotlib.image as mpimgimport matplotlib.pyplot as pltimport pandas as pdimport seaborn as snsimport picklefrom collections import Counteros.chdir("/Users/marleeyork/Documents/project2/")from load_data import *from heatwave_indices import *# Set pandas to print first 110 rowspd.set_option('display.max_rows', 110)# Load in the heatwaves hereos.chdir("/Users/marleeyork/Documents/project2/data/heatwaves/")with open("heatwaves_max.pkl", "rb") as file:    heatwaves = pickle.load(file)with open("heatwaves_min.pkl", "rb") as file:    heatwaves_min = pickle.load(file)with open("heatwaves_min.pkl", "rb") as file:    heatwaves_min = pickle.load(file)with open("heatwaves_mean.pkl", "rb") as file:    heatwaves_EHF = pickle.load(file)    with open("all_heatwaves.pkl", "rb") as file:    all_heatwaves = pickle.load(file)all_heatwaves_df = pd.read_csv("all_heatwaves_df.csv")    # Load in the AmeriFlux and historical datadf = pd.read_csv("/Users/marleeyork/Documents/project2/data/cleaned/AMF_DD.csv")df_hourly = pd.read_csv("/Users/marleeyork/Documents/project2/data/cleaned/AMF_HH.csv")# Load in the SWC and precipitation data# We use to load this directly, but now we used cleaned daily values from dfprec_data = loadAMF(path='/Users/marleeyork/Documents/project2/data/AMFdataDD',                    measures=['TIMESTAMP','P_F'])prec_data = prec_data[prec_data['Site'].isin(df.Site.unique())]swc_data = loadAMF(path='/Users/marleeyork/Documents/project2/data/AMFdataDD',                  measures=['TIMESTAMP','SWC_F_MDS_1'])swc_data = swc_data[swc_data['Site'].isin(df.Site.unique())]# Load in precipitation and SWC for each heatwaveall_precip = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/max_precip.csv")all_precip_mean = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/mean_precip.csv")all_precip_min = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/min_precip.csv")all_swc = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/max_swc.csv")all_swc = all_swc[all_swc.moisture_total >= 0]all_swc_mean = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/mean_swc.csv")all_swc_mean = all_swc_mean[all_swc_mean.swc_total >= 0]all_swc_min = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/min_swc.csv")all_swc_min = all_swc_min[all_swc_min.moisture_total >= 0]# Remove index columnall_swc = all_swc.iloc[:,1:]all_swc_min = all_swc_min.iloc[:,1:]all_swc_mean = all_swc_mean.iloc[:,1:]all_precip = all_precip.iloc[:,1:]all_precip_min = all_precip_min.iloc[:,1:]all_precip_mean = all_precip_mean.iloc[:,1:]# Load in historical datahistorical_data_max = pd.read_csv("/Users/marleeyork/Documents/project2/data/cleaned/historical_data_max.csv")historical_data_mean = pd.read_csv("/Users/marleeyork/Documents/project2/data/cleaned/historical_data_min.csv")historical_data_min = pd.read_csv("/Users/marleeyork/Documents/project2/data/cleaned/historical_data_mean.csv")# Load in IGBPIGBP = pd.read_csv("")#################################################################################                              Site Comparisons                             ################################################################################## Pie chart of number of sites we have by IGBPIGBP_site_counts = df.groupby('IGBP')['Site'].nunique()fig, ax = plt.subplots()ax.pie(    IGBP_site_counts.values,    labels=IGBP_site_counts.index,    autopct=lambda p: f"{int(round(p/100.*sum(IGBP_site_counts.values)))}")plt.title("Unique Sites per IGBP")plt.show()#################################################################################                             Comparison                                    ################################################################################## Now we are going to compare heatwaves defined across each of the 3 approaches# Just stacking the plots of each on top of eachotherfor site in swc_data.Site.unique():    fig1 = heatwaves[site]['plot']    fig2 = heatwaves_EHF[site]['plot']    fig3 = heatwaves_min[site]['plot']    fig1.savefig("plot1.png", bbox_inches="tight")    fig2.savefig("plot2.png", bbox_inches="tight")    fig3.savefig("plot3.png", bbox_inches="tight")    imgs = [mpimg.imread(f"plot{i}.png") for i in range(1, 4)]    fig, axes = plt.subplots(3, 1, figsize=(6, 12))    for ax, img in zip(axes, imgs):        ax.imshow(img)        ax.axis("off")    plt.tight_layout()    plt.show()    #################################################################################                             Summaries                                     ################################################################################## Printing the summaries of heatwaves for each site# Starting with the Max summariesfor site in AMF_data.Site.unique():    print(heatwaves[site]['summary'])    plt.show(heatwaves[site]["plot"])        input("Press [enter] to continue...") # careful with this, can break things# EHF summariesfor site in heatwaves_EHF.keys():    print(heatwaves_EHF[site]['summary'])    plt.show(heatwaves_EHF[site]["plot"])    # Min summaries# Print each of the heatwave summarysfor site in heatwaves_min.keys():    print(heatwaves_min[site]['summary'])    plt.show(heatwaves_min[site]["plot"])#################################################################################                             Moisture                                      ################################################################################## Plotting moisture from max approach# Plot distributions of all moisture datafig, ax = plt.subplots(1,3,figsize=(12,4))ax[0].set_title('Total Precipitation')ax[0].set_xlabel('Precipitation (mm)')ax[0].hist(all_precip['moisture_total'],bins=30)ax[1].hist(all_precip['moisture_average'],bins=30)ax[1].set_title('Average Precipitation')ax[1].set_xlabel('Precipitation (mm)')ax[2].hist(all_swc['moisture_average'],bins=30)ax[2].set_title('Average SWC')ax[2].set_xlabel('SWC (% at -2cm')plt.show()# Plotting moisture from EHF approach# Plot distributions of all moisture datafig, ax = plt.subplots(1,3,figsize=(12,4))ax[0].set_title('Total Precipitation')ax[0].set_xlabel('Precipitation (mm)')ax[0].hist(all_precip_EHF['moisture_total'],bins=30)ax[1].hist(all_precip_EHF['moisture_average'],bins=30)ax[1].set_title('Average Precipitation')ax[1].set_xlabel('Precipitation (mm)')ax[2].hist(all_swc_EHF['moisture_average'],bins=30)ax[2].set_title('Average SWC')ax[2].set_xlabel('SWC (% at -2cm)')plt.show()# Plotting moisture from minimum approach# Plot distributions of all moisture datafig, ax = plt.subplots(1,3,figsize=(12,4))ax[0].set_title('Total Precipitation')ax[0].set_xlabel('Precipitation (mm)')ax[0].hist(all_precip_min['moisture_total'],bins=30)ax[1].hist(all_precip_min['moisture_average'],bins=30)ax[1].set_title('Average Precipitation')ax[1].set_xlabel('Precipitation (mm/day)')ax[2].hist(all_swc_min['moisture_average'],bins=30)ax[2].set_title('Average SWC')ax[2].set_xlabel('SWC (% at -2cm)')plt.show()#################################################################################                          Moisture by IGBP                                 ################################################################################## Importing site information to retrieve IGBPsite_data = pd.read_csv("/Users/marleeyork/Documents/project2/data/site_list.csv",encoding='latin1')# Merge with the swc dataframesall_swc = pd.merge(all_swc,IGBP,on='Site',how='inner').drop_duplicates()all_swc_mean = pd.merge(all_swc_mean,IGBP,on='Site',how='inner').drop_duplicates()all_swc_min = pd.merge(all_swc_min,IGBP,on='Site',how='inner').drop_duplicates()# Merge with precipitation dataframesall_precip = pd.merge(all_precip,IGBP,on='Site',how='inner').drop_duplicates()all_precip_mean = pd.merge(all_precip_mean,IGBP,on='Site',how='inner').drop_duplicates()all_precip_min = pd.merge(all_precip_min,IGBP,on='Site',how='inner').drop_duplicates()# Plot swc histograms grouped by site# Plotting for the max approachplt.figure(figsize=(8,6))sns.kdeplot(    data=all_swc[all_swc["moisture_average"] >= 0],    x="moisture_average",    hue="IGBP",    common_norm=False,    cut=0,           clip=(0, None),    linewidth=2)plt.xlim(0, None)plt.title("SWC Density of Heatwaves by IGBP (Max approach)")plt.xlabel("Average SWC")plt.ylabel("Density")plt.show()# Plotting for the EHF approachplt.figure(figsize=(8,6))sns.kdeplot(    data=all_swc_EHF[all_swc_EHF["moisture_average"] >= 0],    x="moisture_average",    hue="IGBP",    common_norm=False,    cut=0,           clip=(0, None),    linewidth=2)plt.xlim(0, None)plt.title("SWC Density of Heatwaves by IGBP (EHF approach)")plt.xlabel("SWC Average")plt.ylabel("Density")plt.show()# Plotting for the minimum approachplt.figure(figsize=(8,6))sns.kdeplot(    data=all_swc_min[all_swc_min["moisture_average"] >= 0],    x="moisture_average",    hue="IGBP",    common_norm=False,    cut=0,           clip=(0, None),    linewidth=2)plt.xlim(0, None)plt.title("SWC Density of Heatwaves by IGBP (Min approach)")plt.xlabel("Average SWC")plt.ylabel("Density")plt.show()#################################################################################                               Summaries                                   ################################################################################## Organize all the heatwaves into dataframes# Starting with max approachheatwave_df = pd.DataFrame(columns=['Site','start_dates','end_dates','duration'])for site in heatwaves.keys():    # Isolate heatwaves from each approach    maximum = heatwaves[site]['summary'][['start_dates','end_dates','duration']]    EHF = heatwaves_EHF[site]['summary']    minimum = heatwaves_min[site]['summary']    # Label the approach type    maximum["Method"] = ['Max']*maximum.shape[0]    EHF["Method"] = ['EHF']*EHF.shape[0]    minimum["Method"] = ['Min']*minimum.shape[0]    # Add site name to each    maximum['Site'] = [site]*maximum.shape[0]    EHF['Site'] = [site]* EHF.shape[0]    minimum['Site'] = [site]*minimum.shape[0]    # Concat into one dataframe    heatwave_df = pd.concat([heatwave_df,maximum])    heatwave_df = pd.concat([heatwave_df,EHF])    heatwave_df = pd.concat([heatwave_df,minimum])    # Load in precipitation and SWC for each heatwaveall_precip = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/max_precip.csv")all_precip_EHF = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/mean_precip.csv")all_precip_min = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/min_precip.csv")all_swc = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/max_swc.csv")all_swc = all_swc[all_swc.moisture_total >= 0]all_swc_EHF = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/mean_swc.csv")all_swc_EHF = all_swc_EHF[all_swc_EHF.moisture_total >= 0]all_swc_min = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/min_swc.csv")all_swc_min = all_swc_min[all_swc_min.moisture_total >= 0]# Remove index columnall_swc = all_swc.iloc[:,1:]all_swc_min = all_swc_min.iloc[:,1:]all_swc_EHF = all_swc_EHF.iloc[:,1:]all_precip = all_precip_EHF.iloc[:,1:]all_precip_min = all_precip_min.iloc[:,1:]all_precip_EHF = all_precip_EHF.iloc[:,1:]# Merge with the swc dataframesall_swc = pd.merge(all_swc,IGBP,on='Site',how='inner').drop_duplicates()all_swc_EHF = pd.merge(all_swc_EHF,IGBP,on='Site',how='inner').drop_duplicates()all_swc_min = pd.merge(all_swc_min,IGBP,on='Site',how='inner').drop_duplicates()# Merge with precipitation dataframesall_precip = pd.merge(all_precip,IGBP,on='Site',how='inner').drop_duplicates()all_precip_EHF = pd.merge(all_precip_EHF,IGBP,on='Site',how='inner').drop_duplicates()all_precip_min = pd.merge(all_precip_min,IGBP,on='Site',how='inner').drop_duplicates()    # Add IGBP to the dataframeheatwave_df = pd.merge(heatwave_df,IGBP,on='Site',how='inner')# For the sake of this analysis, I am going to drop the croplandsheatwave_df = heatwave_df[heatwave_df['IGBP']!="CRO"]# Now we start calculating some interesting statistics# Number of heatwaves overall, and for each IGBPheatwave_df.groupby("Method").count()heatwave_df.groupby(["Method","IGBP"]).count()# Investigating the time of year# Adding a seasonal categorical variable and adding into the dataframeseasons = []for dt in heatwave_df.start_dates:    if dt.month in [3,4,5]:        seasons.append('Spring')    elif dt.month in [6,7,8]:        seasons.append('Summer')    elif dt.month in [9,10,11]:        seasons.append('Fall')    elif dt.month in [12,1,2]:        seasons.append('Winter')    else:        print(f"Something went wrong with date {dt}.")        seasons.append("Error")heatwave_df['Season'] = seasons    # Counting the number of heatwaves for each seasonheatwave_df.groupby(["Method","Season"]).count()    # Looking at the average duration of heatwavesheatwave_df.duration = heatwave_df.duration.dt.daysheatwave_df.groupby("Method").duration.mean()heatwave_df.groupby("Method").duration.quantile([0,.05,.25,.5,.75,.95,1])# Now we investigate the moisture conditions across each# Renaming columns of soil water content dataframesall_swc.columns = ['start_date','end_date','swc_average','swc_total','Site','swc_variability','IGBP']all_swc_EHF.columns = ['start_date','end_date','swc_average','swc_total','swc_variability','Site','IGBP']all_swc_min.columns = ['start_date','end_date','swc_average','swc_total','Site','swc_variability','IGBP']# Adding a methods column to eachall_swc["Method"] = ["Max"]*all_swc.shape[0]all_swc_EHF["Method"] = ["EHF"]*all_swc_EHF.shape[0]all_swc_min["Method"] = ["Min"]*all_swc_min.shape[0]# Concatenate the swc dataframesswc = pd.concat([all_swc,all_swc_EHF,all_swc_min])swc.columns = ['start_dates','end_dates','swc_average','swc_total','Site','swc_variability','IGBP','Method']# Convert dates to a datetime objectswc['start_dates'] = pd.to_datetime(swc.start_dates)swc['end_dates'] = pd.to_datetime(swc.end_dates)# Remove any heatwaves with missing swc dataswc = swc[swc['swc_total'] >= 0]# Match swc to each heatwave using mergeheatwave_df = pd.merge(heatwave_df,swc,on=["Site","Method","start_dates","end_dates","IGBP"],how="inner")# Calculate the quantiles for swcheatwave_df.swc_average = heatwave_df.swc_average.astype("int")heatwave_df.groupby("Method").swc_average.quantile([.05,.25,.5,.75,.95])# Now we do the same for precipitation# Start by rrenaming columns of precipitation dataframesall_precip.columns = ['start_dates','end_dates','precip_average','precip_total','precip_variability','Site','Duration','IGBP']all_precip_EHF.columns = ['start_dates','end_dates','precip_average','precip_total','precip_variability','Site','Duration','IGBP']all_precip_min.columns = ['start_dates','end_dates','precip_average','precip_total','Site','Duration','precip_variability','IGBP']# Adding a methods columns to eachall_precip["Method"] = ["Max"]*all_precip.shape[0]all_precip_EHF["Method"] = ["EHF"]*all_precip_EHF.shape[0]all_precip_min["Method"] = ["Min"]*all_precip_min.shape[0]# Concatenate the dataframesprecip = pd.concat([all_precip,all_precip_EHF,all_precip_min])# Convert dates into datetime precip['start_dates'] = pd.to_datetime(precip.start_dates)precip['end_dates'] = pd.to_datetime(precip.end_dates)# Merge precipitation onto the heatwavesheatwave_df = pd.merge(heatwave_df,precip.drop(columns=['Duration']),on=["Site","Method","start_dates","end_dates","IGBP"],how="inner")# Calculate the quantiles for precipitationheatwave_df.groupby(["Method","IGBP"]).precip_total.quantile([.05,.25,.5,.75,1])heatwave_df.groupby(["Method","IGBP"]).precip_average.quantile([.05,.25,.5,.75,1])# Now lets create a boxplot that compares these quantiles# Starting with SWCsns.boxplot(data=heatwave_df, x='IGBP', y='swc_average', hue='Method')plt.title('Avg SWC by IGBP and Method')plt.ylabel("SWC Average (%/d) per Heatwave")plt.show()# Now variation in SWC, with showflierssns.boxplot(data=heatwave_df, x='IGBP', y='swc_variability',hue='Method')plt.title('SWC Variation by IGBP and Method')plt.ylabel("SWC Variation per Heatwave")plt.show()# Now variation in SWC, without showflierssns.boxplot(data=heatwave_df, x='IGBP', y='swc_variability',hue='Method',showfliers=False)plt.title('SWC Variation by IGBP and Method')plt.ylabel("SWC Variation per Heatwave")plt.show()# Now variation in SWC based on duration, along with counts of how many observations# of each heatwave duration we havedf_dur = heatwave_df[heatwave_df['duration'] < 13]counts = (    df_dur.groupby(['duration', 'Method'])      .size()      .reset_index(name='n'))ax = sns.boxplot(data=df_dur, x='duration', y='swc_variability',                 hue='Method', showfliers=False)methods = counts['Method'].unique()n_methods = len(methods)group_width = 0.8step = group_width / n_methodsoffsets = {    method: (-group_width/2 + step/2) + i*step    for i, method in enumerate(methods)}durations_sorted = sorted(df_dur['duration'].unique())ypos = df_dur['swc_variability'].min() - 0.05for _, row in counts.iterrows():    dur = row['duration']    method = row['Method']    n = row['n']    dur_index = durations_sorted.index(dur)   # <-- key fix    xpos = dur_index + offsets[method]        # use index, not value    ax.text(xpos, ypos, f"{n}", ha='center', va='top', fontsize=8)plt.title("SWC Variation by Heatwave Duration")plt.show()# Now precipitation totalsns.boxplot(data=heatwave_df, x='IGBP', y='precip_total', hue='Method')plt.title('Total Preciptation by IGBP and Method')plt.ylabel("Precipitation Total (mm) per Heatwave")plt.show()# Now precipitation averagesns.boxplot(data=heatwave_df, x='IGBP', y='precip_average', hue='Method')plt.title('Avg Preciptation by IGBP and Method')plt.ylabel("Precipitation Avg (mm/d) per Heatwave")plt.show()# Standardizing SWC and precipitation by site# First find the mean SWC at each site# Need to find where the precipitation data is stored... and if the swc_data is the right dataframeswc_site_data = swc_data.groupby('Site')['SWC_F_MDS_1'].agg(['mean', 'std']).reset_index()swc_site_data.columns = ['Site','swc_site_mean','swc_site_sd']prec_site_data = prec_data.groupby('Site')['P_F'].agg(['mean','std']).reset_index()prec_site_data.columns = ['Site','prec_site_mean','prec_site_sd']# Now merge with the heatwave dfheatwave_df = pd.merge(heatwave_df,swc_site_data,on="Site",how="inner")heatwave_df = pd.merge(heatwave_df,prec_site_data,on="Site",how="inner")# Calculate the standardized vaues of moisture conditions# Note: standardized in assumes normality, which is not true here. I also included just the centered values.heatwave_df['swc_standardized'] = (heatwave_df['swc_average'] - heatwave_df['swc_site_mean']) / heatwave_df['swc_site_sd']heatwave_df['swc_centered'] = heatwave_df['swc_average'] - heatwave_df['swc_site_mean']heatwave_df['prec_standardized'] = (heatwave_df['precip_average'] - heatwave_df['prec_site_mean']) / heatwave_df['prec_site_mean']heatwave_df['prec_centered'] = heatwave_df['precip_average'] - heatwave_df['prec_site_mean']# Make a boxplot of centered average soil water contentsns.boxplot(data=heatwave_df, x='IGBP', y='swc_centered', hue='Method')plt.axhline(0, color='black', linestyle='--', linewidth=1)plt.title('Avg SWC of Heatwaves Centered by Site by IGBP')plt.ylabel("Centered Heatwave Avg SWC (%/d) by IGBP")plt.show()# Make a boxplot of centered average precipitationsns.boxplot(data=heatwave_df,x="IGBP",y="prec_centered",hue="Method")plt.axhline(0,color="black",linestyle="--",linewidth=1)plt.title('Avg Precipitation of Heatwaves Centered by Site by IGBP')plt.ylabel("Centered Heatwave Avg Precipitation (mm/d) by IGBP")plt.show()#################################################################################                           Overlapping heatwaves                           ################################################################################## Load in the heatwaves dataframeall_heatwaves_df = pd.read_csv("/Users/marleeyork/Documents/project2/data/heatwaves/all_heatwaves_df.csv")# Make sure the dates are all datetime objectsall_heatwaves_df['start_dates'] = pd.to_datetime(all_heatwaves_df['start_dates'])all_heatwaves_df['end_dates'] = pd.to_datetime(all_heatwaves_df['end_dates'])df['date'] = pd.to_datetime(df['date'])# Plotting heatwaves for each sitefor site in all_heatwaves_df.Site.unique():    site_heatwaves = all_heatwaves_df[all_heatwaves_df.Site==site]    site_df = df[df.Site==site]    # Plot the temperature timeseries    plt.subplots()    plt.scatter(site_df.date,site_df.TA_F,s=.5)    for row in site_heatwaves[['start_dates','end_dates']].itertuples(index=False):        start, end = row        date_range = pd.date_range(start,end)        plt.scatter(site_df[site_df.date.isin(date_range)].date,site_df[site_df.date.isin(date_range)].TA_F,c='red',s=.5)    plt.title(site)    plt.show()    input("Press [enter] to continue...")# Combining heatwave type counts across all sitescount_df = pd.DataFrame({    site: all_heatwaves[site]['heatwave_type_counts']    for site in all_heatwaves})total_counts = count_df.sum(axis=1)# Bar plot of the heatwave type frequencytotal_counts_sorted = total_counts.sort_values(ascending=False)plt.figure(figsize=(10, 6))plt.bar(total_counts_sorted.index, total_counts_sorted.values)plt.xlabel("Heatwave Category")plt.ylabel("Total Count Across All Sites")plt.title("Total Heatwave Category Counts Across Sites")plt.xticks(rotation=45, ha='right')plt.tight_layout()plt.show()# Making a bar plot of heatwave types by IGBPall_heatwaves_df = pd.merge(all_heatwaves_df,IGBP,on='Site',how='left')pivot = (    all_heatwaves_df    .groupby(["IGBP", "top_heatwave"])    .size()    .unstack(fill_value=0))pivot.plot(kind="bar", stacked=True, figsize=(12,6))plt.ylabel("Number of Heatwaves")plt.xlabel("IGBP Class")plt.title("Heatwave Type Distribution by IGBP")plt.xticks(rotation=45)plt.tight_layout()plt.show()# Making a bar plot of heatwave types by seasonpivot = (    all_heatwaves_df    .groupby(["Season","top_heatwave"])    .size()    .unstack(fill_value=0)    )pivot.plot(kind="bar", stacked=True, figsize=(12,6))plt.ylabel("Number of Heatwaves")plt.xlabel("Season")plt.title("Heatwave Type Distribution by Season")plt.xticks(rotation=45)plt.tight_layout()plt.show()# Looking at heatwave frequency across the yearsall_heatwaves_df['year'] = all_heatwaves_df.start_dates.dt.yearyearly_counts = all_heatwaves_df.groupby(['Site','year']).size().reset_index(name='count')yearly_counts = pd.merge(yearly_counts,IGBP,on='Site',how='left')yearly_avg = yearly_counts.groupby('year')['count'].mean().reset_index(name='avg_per_site')yearly_avg_IGBP = yearly_counts.groupby(['year','IGBP'])['count'].mean().reset_index(name='avg_per_site')yearly_type_counts = all_heatwaves_df.groupby(['Site','top_heatwave','year']).size().reset_index(name='count')yearly_type_avg = yearly_type_counts.groupby(['year','top_heatwave'])['count'].mean().reset_index(name='avg_per_site')# Plotting frequency of heatwaves per site per yearplt.subplots()for site, group in yearly_counts.groupby('Site'):    plt.plot(group['year'], group['count'], marker='o', label=site)plt.xlabel('Year')plt.ylabel('Heatwave Count')plt.title('Heatwave Counts per Site Across Years')plt.legend(title='Site')plt.show()# Plotting average heatwave per site by yearplt.subplots()plt.plot(yearly_avg.year,yearly_avg.avg_per_site,marker='o')plt.xlabel('Year')plt.ylabel('Average Heatwaves per Site')plt.show()# Plotting frequency of heatwaves per year by IGBPplt.subplots()for IGBP, group in yearly_avg_IGBP.groupby('IGBP'):    plt.plot(group['year'],group['avg_per_site'],marker='o',label=IGBP,linewidth=1,markersize=4)plt.xlabel('Year')plt.ylabel('Average Heatwaves per Site')plt.legend(title='IGBP')plt.show()# Plotting frequency of heatwaves per year by heatwave typeplt.subplots()for type, group in yearly_type_avg.groupby('top_heatwave'):    plt.plot(group['year'],group['avg_per_site'],marker='o',label=type,linewidth=1,markersize=4)plt.xlabel('Year')plt.ylabel('Average Heatwaves per Site')plt.legend(title='Heatwave Type',fontsize='small',title_fontsize='small')plt.tight_layout()plt.show()# Now looking at the moisture distributions for each of these heatwave typessns.boxplot(data=all_heatwaves_df,x='top_heatwave',y='swc_average',showfliers=True) plt.xticks(rotation=45)plt.xlabel("Heatwave Type")plt.ylabel("SWC Average")plt.show()sns.boxplot(data=all_heatwaves_df,x='top_heatwave',y='swc_variability',showfliers=True)plt.xticks(rotation=45)plt.xlabel("Heatwave Type")plt.ylabel("SWC Variation")plt.show()sns.boxplot(data=all_heatwaves_df,x='top_heatwave',y='prec_average')plt.xticks(rotation=45)plt.xlabel("Heatwave Type")plt.ylabel("Precipitation Average")plt.show()sns.boxplot(data=all_heatwaves_df,x='top_heatwave',y='prec_variability')plt.xticks(rotation=45)plt.xlabel("Heatwave Type")plt.ylabel("Precipitation Variation")plt.show()# Moisture distributions by heatwave duration# We are going to look at up to 15 days in duration, since theres sufficient data up until thenshort_heatwaves = all_heatwaves_df[all_heatwaves_df['duration']<21]plt.figure(figsize=(10, 6)) ax = sns.boxplot(data=short_heatwaves,x='duration',y='swc_average',flierprops={'markersize': 2},showfliers=True)ax.set_xlabel("Heatwave Duration", fontsize=8)ax.set_ylabel("SWC Average During Heatwave", fontsize=8)ax.tick_params(axis='both', which='major', labelsize=4)counts = short_heatwaves['duration'].value_counts().sort_index()ymin, ymax = ax.get_ylim()ypos = ymin + (ymax - ymin) * 0.02   # 3% above bottom of axis â€” inside plotfor i, duration in enumerate(counts.index):    ax.text(        i,        ypos,        counts.loc[duration],        ha='center',        va='bottom',        fontsize=4    )plt.show()# Limit dataframe sites to those in the heatwavesdf = df[df.Site.isin(list(heatwaves_min.keys()))]df_hourly = df_hourly[df_hourly.Site.isin(list(heatwaves_min.keys()))]# Now lets calculate the cumulative exceedence, starting with average datamean_temp_exceedence = cumulative_exceedence(heatwaves_dictionary = all_heatwaves,                                             AMF_TA = df,                                             historical_data = historical_data_mean,                                             method='mean')mean_temp_exceedence.columns = ['Site','start_dates','end_dates','TAmean_cumexc','TAmean_avgexc']# Now lets calculate cumulative exceedence for maximum datamax_temp_exceedence = cumulative_exceedence(heatwaves_dictionary = all_heatwaves,                                            AMF_TA = df_hourly,                                            historical_data = historical_data_max,                                            method = 'max')max_temp_exceedence.columns = ['Site','start_dates','end_dates','TAmax_cumexc','TAmax_avgexc']# Now we calculate cumulative exceedence for minimum datamin_temp_exceedence = cumulative_exceedence(heatwaves_dictionary = all_heatwaves,                                            AMF_TA = df_hourly,                                            historical_data = historical_data_min,                                            method = 'min')min_temp_exceedence.columns = ['Site','start_dates','end_dates','TAmin_cumexc','TAmin_avgexc']# Merging these altogetherall_heatwaves_df = pd.merge(all_heatwaves_df,mean_temp_exceedence,on=['Site','start_dates','end_dates'],how='left')all_heatwaves_df = pd.merge(all_heatwaves_df,max_temp_exceedence,on=['Site','start_dates','end_dates'],how='left')all_heatwaves_df = pd.merge(all_heatwaves_df,min_temp_exceedence,on=['Site','start_dates','end_dates'],how='left')# Plotting exceedence by heatwave typeplt.subplots()sns.boxplot(data = all_heatwaves_df,x='top_heatwave',y='TAmean_avgexc')plt.xticks(rotation=45)plt.xlabel("Heatwave Type")plt.ylabel("Average Exceedence of Mean Temperature")plt.show()plt.subplots()sns.boxplot(data = all_heatwaves_df,x='top_heatwave',y='TAmax_avgexc',showfliers=False)plt.xticks(rotation=45)plt.xlabel("Heatwave Type")plt.ylabel("Average Exceedence of Max Temperature")plt.show()plt.subplots()sns.boxplot(data = all_heatwaves_df,x='top_heatwave',y='TAmin_avgexc')plt.xticks(rotation=45)plt.xlabel("Heatwave Type")plt.ylabel("Average Exceedence of Min Temperature")plt.show()# Plotting exceedence by IGBPfig, ax = plt.subplots()sns.boxplot(data = all_heatwaves_df,x='IGBP',y='TAmean_avgexc')plt.xticks(rotation=45)plt.xlabel("IGBP")plt.ylabel("Average Exceedence of Mean Temperature")counts = all_heatwaves_df['IGBP'].value_counts()for i, category in enumerate(counts.index):    count = counts[category]    ax.text(i,             ax.get_ylim()[1]*0.95,   # place near top of y-axis            f"n={count}",             ha='center', va='top', fontsize=8, color='black')plt.tight_layout()plt.show()plt.subplots()sns.boxplot(data = all_heatwaves_df,x='IGBP',y='TAmax_avgexc',showfliers=False)plt.xticks(rotation=45)plt.xlabel("IGBP")plt.ylabel("Average Exceedence of Max Temperature")plt.show()plt.subplots()sns.boxplot(data = all_heatwaves_df,x='IGBP',y='TAmin_avgexc')plt.xticks(rotation=45)plt.xlabel("IGBP")plt.ylabel("Average Exceedence of Min Temperature")plt.show()